---
title: "Reefs Mesocosm"
author: "Olivier V. Raven"
format:
  html:
    toc: true
    number-sections: true
    code-fold: true
    code-summary: "Show code"
    code-tools: true
execute:
  freeze: auto
  warning: false
  message: false
---

## Overview
This site accompanies the scientific work on: *Reefs Mesocosm*.

- **Code repository:** (add URL)
- **Data DOI:** (add DOI link)
- **Paper DOI:** (add DOI link)
- **Title:** Reefs Mesocosm

## Setup
```{r}
#| label: setup
packages <- c("XNomial","brms","nnet","lme4","multcompView","patchwork","janitor","lubridate","stringr","tidyverse","dplyr","ggplot2","readxl","writexl","readr")


quiet_load <- function(pkg) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    suppressWarnings(suppressMessages(install.packages(pkg, dependencies = TRUE)))}
  suppressPackageStartupMessages(require(pkg, character.only = TRUE, quietly = TRUE))
  invisible(TRUE)}

invisible(lapply(packages, quiet_load))

base_theme_bw <- theme_classic() +
  theme(text     = element_text(family = "Arial", size = 11),
    axis.title   = element_text(face = "plain"),
    axis.text    = element_text(face = "plain"),
    plot.title   = element_text(face = "plain"),
    strip.text   = element_text(face = "plain"),
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.3))
theme_set(base_theme_bw)
```

# Load raw data
```{r}
#| label: load-data
exc_file_dir    <- "data/raw/Mesocosm_experiment.xlsx"
raw_data_dir    <- "data/raw"
der_data_dir    <- "data/derived"
fig_dir         <- "figures"


read_sheet <- function(sheet) {readxl::read_excel(exc_file_dir, sheet = sheet)}
write_out <- function(df, name) {write.csv(df, file.path(der_data_dir, name), row.names = FALSE)}

# Read data
df_koura          <- read_sheet("Koura")
df_setup          <- read_sheet("Tank_setup")
df_single_raw     <- read_sheet("Reef_single")
df_group_raw      <- read_sheet("Reef_group")
df_stonewood_raw  <- read_sheet("Stone_wood")
df_brick_raw      <- read_sheet("Bricks")
df_wq             <- read_sheet("WQ")
df_loggers        <- read_sheet("Loggers")

# set preferred orders
REEF_LEVELS  <- c("SingleStone","FlatStone","StonePile","WoodLog","TankWall")
REEF_LEVELS3 <- c("FlatStone","WoodSplit","TankWall")
REEF_LEVELS4 <- c("Brick_Artificial","Brick_Wood","TankWall")
LOC_LEVELS   <- c("A", "B", "C", "D", "E")
LOC_LEVELS3  <- c("A", "B", "E")

relevel_reef  <- function(df) df %>% mutate(reef_type = factor(as.character(reef_type),levels = REEF_LEVELS))
relevel_reef3 <- function(df) df %>% mutate(reef_type = factor(as.character(reef_type),levels = REEF_LEVELS3))
relevel_reef4 <- function(df) df %>% mutate(reef_type = factor(as.character(reef_type),levels = REEF_LEVELS4))
```

# Length-Weight of koura
```{r}
#| label: Length-Weight of koura
#| fig-width: 6
#| fig-height: 7
#| dpi: 120
#| fig-cap: "."

summarise_size_weight <- function(df) {
  df %>%
    summarise(
      n_size          = sum(!is.na(size_mm1)),
      n_weight        = sum(!is.na(weight_g1)),
      size_mm1_mean   = mean(size_mm1, na.rm = TRUE),
      size_mm1_sd     = sd(size_mm1, na.rm = TRUE),
      size_mm1_range  = paste0(min(size_mm1, na.rm = TRUE), "–", max(size_mm1, na.rm = TRUE)),
      weight_g1_mean  = mean(weight_g1, na.rm = TRUE),
      weight_g1_sd    = sd(weight_g1, na.rm = TRUE),
      weight_g1_range = paste0(min(weight_g1, na.rm = TRUE), "–", max(weight_g1, na.rm = TRUE))
    )
}

summarise_size_weight(df_single_raw)
summarise_size_weight(df_group_raw)
summarise_size_weight(df_stonewood_raw)
summarise_size_weight(df_brick_raw)

```

# Make DF's into long format
```{r}
#| label: Long format

df_single_long <- df_single_raw %>%
  mutate(location_l0 = l0, location_l1 = l1) %>%
  pivot_longer(cols = matches("_(l0|l1)$"),
    names_to = c(".value", "stage"),
    names_pattern = "^(.*)_(l[01])$") %>%
  mutate(stage         = toupper(stage),
    location_code = factor(toupper(location), levels = LOC_LEVELS),
    reef_type     = factor(reef, levels = REEF_LEVELS)) %>%
  select(tank, round, group_id, koura_id, size_class, sex, size_mm1, weight_g1, date, stage, t_leave_s, t_l0_s, location_code, reef_type,legs1, claws1, antenna1, size_mm2, weight_g2, legs2, claws2, antenna2,notes_exp, notes_koura)

write_out(df_single_long, "df_single_long.csv")

# EXP 2 – Group reefs (long)
df_group_long <- df_group_raw %>%
  mutate(location_l0 = l0, location_l1 = l1) %>%
  pivot_longer(cols = c(location_l0, location_l1,
      reef_l0, reef_l1,legs_l0, claws_l0, antenna_l0,legs_l1, claws_l1, antenna_l1), names_to = c(".value", "stage"), names_pattern = "^(.*)_(l[01])$") %>%
  mutate(stage          = toupper(stage),
    location_code  = factor(toupper(location), levels = LOC_LEVELS),
    reef_type      = factor(reef, levels = REEF_LEVELS),
    size_mm_stage  = if_else(stage == "L0", size_mm1, size_mm2, NA_real_),
    weight_g_stage = if_else(stage == "L0", weight_g1, weight_g2, NA_real_)) %>%
  select(tank, round, group_id, koura_id, size_class, sex, date,stage, t_leave_s, t_l0_s, location_code, reef_type,legs, claws, antenna, size_mm_stage, weight_g_stage,size_mm1, weight_g1, legs1, claws1, antenna1,size_mm2, weight_g2, legs2, claws2, antenna2,notes_exp, notes_koura)

write_out(df_group_long, "df_group_long.csv")


# EXP 3 – Stone / wood (long)
df_stonewood_long <- df_stonewood_raw %>%
  mutate(location_l0 = l0, location_l1 = l1) %>%
  pivot_longer(cols = c(location_l0, location_l1, reef_l0, reef_l1),
    names_to = c(".value", "stage"),
    names_pattern = "^(.*)_(l[01])$") %>%
  mutate(stage         = toupper(stage),
    location_code = factor(toupper(location), levels = LOC_LEVELS3),
    reef_type     = factor(reef, levels = REEF_LEVELS3)) %>%
  select(tank, round, group_id, koura_id, size_class, sex, date, stage, location_code, reef_type, size_mm1, weight_g1, legs1, claws1, antenna1, size_mm2, weight_g2, legs2, claws2, antenna2, notes_exp, notes_koura)

write_out(df_stonewood_long, "df_stonewood_long.csv")


# EXP 4 – Bricks (long)
df_brick_long <- df_brick_raw %>%
  mutate(location_l1 = l1) %>%
  pivot_longer(cols = c(location_l1, reef_l1),
    names_to = c(".value", "stage"),
    names_pattern = "^(.*)_(l[01])$") %>%
  mutate(stage         = toupper(stage),
    location_code = factor(toupper(location), levels = LOC_LEVELS),
    reef_type     = factor(reef, levels = REEF_LEVELS4)) %>%
  select(tank, round, group_id, koura_id, size_class, sex, date, stage, location_code, reef_type,size_mm1, weight_g1, legs1, claws1, antenna1,size_mm2, weight_g2, legs2, claws2, antenna2,notes_exp, notes_koura)

write_out(df_brick_long, "df_brick_long.csv")
```

# Exp 1 Single koura
```{r}
#| label: Exp 1
#| fig-width: 6
#| fig-height: 7
#| dpi: 120
#| fig-cap: "."

exp1_reef_combined <- df_single_long %>%
  filter(stage %in% c("L0","L1")) %>%
  count(stage, reef_type, name = "n") %>%
  group_by(stage) %>%
  mutate(N = sum(n), prop = n / N) %>%
  ungroup() %>%
  relevel_reef() %>%
  mutate(panel = "Combined")

exp1_reef_bysex <- df_single_long %>%
  filter(stage %in% c("L0","L1")) %>%
  count(stage, reef_type, sex, name = "n") %>%
  group_by(stage, sex) %>%
  mutate(N = sum(n), prop = n / N) %>%
  ungroup() %>%
  relevel_reef() %>%
  mutate(panel = dplyr::recode(sex, F = "Female", M = "Male")) %>%
  select(-sex)

exp1_reef_all <- dplyr::bind_rows(exp1_reef_combined, exp1_reef_bysex)

lab_stage <- c(L0 = "Initial location (L0)", L1 = "Next-day location (L1)")
lab_panel <- c(Combined = "Combined", Female = "Female", Male = "Male")

# One plot
p_exp1_reef_all <- exp1_reef_all %>%
  relevel_reef() %>%
  ggplot(aes(reef_type, prop)) +
  geom_col(color = "black") +
  facet_grid(panel ~ stage, labeller = labeller(stage = lab_stage, panel = lab_panel)) +
  labs(x = "Reef type", y = "Proportion")

p_exp1_reef_all
ggsave(p_exp1_reef_all, file = file.path(fig_dir, "Exp1_reef_p.png"), width = 8, height = 6, dpi = 300)

```

## Exp 1 II
```{r}
#| label: Exp 1 II
#| fig-width: 6
#| fig-height: 7
#| dpi: 120
#| fig-cap: "."

invisible(capture.output({
  # proportions by x var and facet var (per stage)
  mk_props <- function(data, xvar, facetvar) {
    data %>%
      dplyr::filter(stage %in% c("L0","L1")) %>%
      dplyr::count(stage, {{ xvar }}, {{ facetvar }}, name = "n") %>%
      dplyr::group_by(stage, {{ facetvar }}) %>%
      dplyr::mutate(N = sum(n), prop = n / N) %>%
      dplyr::ungroup()
  }

  # bar plot; rows = facetvar, cols = stage; fixed y-scale across all plots
  mk_bar <- function(df, xvar, facetvar, title, reef = FALSE) {
    p <- ggplot(df, aes({{ xvar }}, prop)) +
      geom_col(color = "black") +
      facet_grid(rows = vars({{ facetvar }}), cols = vars(stage)) +
      labs(title = title) +
      scale_y_continuous(limits = c(0, 1), expand = expansion(mult = c(0, 0.05)))
    if (reef) {
      p <- p +
        scale_x_discrete(limits = REEF_LEVELS, drop = FALSE) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))
    }
    p
  }

  # data
  exp1_loc    <- mk_props(df_single_long, location_code, tank)
  exp1_round  <- mk_props(df_single_long, location_code, round)
  exp1_loc2   <- mk_props(df_single_long, reef_type,     tank)
  exp1_round2 <- mk_props(df_single_long, reef_type,     round)

  # plots
  p_exp1_loc    <- mk_bar(exp1_loc,   location_code, tank,  "Location by tank")
  p_exp1_round  <- mk_bar(exp1_round, location_code, round, "Location by round")
  p_exp1_loc2   <- mk_bar(exp1_loc2,  reef_type,     tank,  "Reeftype by tank",  reef = TRUE)
  p_exp1_round2 <- mk_bar(exp1_round2,reef_type,     round, "Reeftype by round", reef = TRUE)

  loc_round_plots_exp1 <<- p_exp1_loc + p_exp1_loc2 + p_exp1_round + p_exp1_round2 +
    patchwork::plot_layout(ncol = 4)
}))
loc_round_plots_exp1

```

## Exp 1 III
```{r}
#| label: Exp 1 III
#| fig-width: 6
#| fig-height: 7
#| dpi: 120
#| fig-cap: "."

exp1_pairs <- df_single_long %>%
  dplyr::filter(stage %in% c("L0","L1")) %>%
  dplyr::select(koura_id, tank, round, size_class, sex, stage,location_code, reef_type, t_leave_s, t_l0_s) %>%
  dplyr::mutate(
    location_code = forcats::fct_drop(factor(location_code, levels = LOC_LEVELS)),
    reef_type     = forcats::fct_drop(factor(reef_type,     levels = REEF_LEVELS)),
    t_leave_s     = suppressWarnings(as.numeric(t_leave_s)),
    t_l0_s        = suppressWarnings(as.numeric(t_l0_s))) %>%
  tidyr::pivot_wider(names_from = stage,values_from = c(location_code, reef_type, t_leave_s, t_l0_s),names_sep = "_")

activity_df <- exp1_pairs %>%
  dplyr::transmute(koura_id, tank, round, size_class, sex, time_to_leave = t_leave_s_L0, time_at_L0 = t_l0_s_L0) 

activity_long <- activity_df %>%
  mutate(
    time_to_leave = suppressWarnings(as.numeric(time_to_leave)),time_at_L0    = suppressWarnings(as.numeric(time_at_L0))) %>%
  pivot_longer(c(time_to_leave, time_at_L0), names_to = "metric", values_to = "time") %>%
  filter(!is.na(time), time >= 0)

lab_metric <- c(time_to_leave = "Time to leave start (t_leave)",
                time_at_L0    = "Time to reach initial hide (t_L0)")

act_exp1_p <- ggplot(activity_long, aes(time, col=sex)) +
  stat_ecdf(geom = "step") +
  facet_grid( ~ metric, labeller = labeller(metric = lab_metric)) +
  labs(x = "Time (s)", y = "Proportion completed by time")

act_exp1_p

```

## Exp 1 Statistic
```{r}
#| label: Statistics Exp 1
#| fig-width: 6
#| fig-height: 7
#| dpi: 120
#| fig-cap: "."

df1 <- df_single_long %>%
  mutate(
    reef_type      = factor(reef_type),
    stage          = factor(stage, levels = c("L0", "L1")),
    sex            = factor(sex),
    size_class     = factor(size_class),
    location_code  = factor(location_code),
    tank           = factor(tank),
    round          = factor(round),
    koura_id       = factor(koura_id),
    size_mm1       = as.numeric(size_mm1),
    weight_g1      = as.numeric(weight_g1)) %>%
  filter(!is.na(reef_type))

# most preferred reef at L1
df1_L1 <- df1 %>% filter(stage == "L1")

tab_L1 <- table(df1_L1$reef_type)
tab_L1_nz <- tab_L1[tab_L1 > 0]        
XNomial::xmulti(obs  = as.numeric(tab_L1_nz), expr = rep(sum(tab_L1_nz) / length(tab_L1_nz), length(tab_L1_nz)))



# Test between L0 and L1
m_exp1 <- nnet::multinom(reef_type ~ stage + sex + size_mm1, data = df1)
m_exp1. <- nnet::multinom(reef_type ~ sex + size_mm1, data = df1)
summary(m_exp1)
summary(m_exp1.)
confint(m_exp1)
anova(m_exp1, m_exp1., test = "Chisq")
```

# Exp 2 Group koura
```{r}
#| label: Exp 2
#| fig-width: 6
#| fig-height: 7
#| dpi: 120
#| fig-cap: "."

exp2_reef_combined <- df_group_long %>%
  filter(stage %in% c("L0","L1")) %>%
  count(stage, reef_type, name = "n") %>%
  group_by(stage) %>%
  mutate(N = sum(n), prop = n / N) %>%
  ungroup() %>%
  relevel_reef() %>%
  mutate(panel = "Combined")

# By size class
exp2_reef_bysize <- df_group_long %>%
  filter(stage %in% c("L0","L1")) %>%
  count(stage, reef_type, size_class, name = "n") %>%
  group_by(stage, size_class) %>%
  mutate(N = sum(n), prop = n / N) %>%
  ungroup() %>%
  relevel_reef() %>%
  mutate(panel = dplyr::recode(as.character(size_class), S = "Small", M = "Medium", L = "Large")) %>%
  select(-size_class)

# Bind for one facetted plot
exp2_reef_all <- dplyr::bind_rows(exp2_reef_combined, exp2_reef_bysize)

# Labels 
lab_stage <- c(L0 = "Initial location (L0)", L1 = "Next-day location (L1)")
lab_panel <- c(Combined = "Combined", Small = "Small", Medium = "Medium", Large = "Large")

# One plot
p_exp2_reef_all <- exp2_reef_all %>%
  relevel_reef() %>%
  ggplot(aes(reef_type, prop)) +
  geom_col(color = "black") +
  facet_grid(panel ~ stage, labeller = labeller(stage = lab_stage, panel = lab_panel)) +
  labs(x = "Reef type", y = "Proportion")

p_exp2_reef_all
ggsave(p_exp2_reef_all, file = file.path(fig_dir, "Exp2_reef_p.png"), width = 8, height = 8, dpi = 300)
```

## Exp 2 II
```{r}
#| label: Exp 2 II
#| fig-width: 6
#| fig-height: 7
#| dpi: 120
#| fig-cap: "."

invisible(capture.output({

  # proportions by x var and facet var (per stage)
  mk_props <- function(data, xvar, facetvar) {
    data %>%
      dplyr::filter(stage %in% c("L0","L1")) %>%
      dplyr::count(stage, {{ xvar }}, {{ facetvar }}, name = "n") %>%
      dplyr::group_by(stage, {{ facetvar }}) %>%
      dplyr::mutate(N = sum(n), prop = n / N) %>%
      dplyr::ungroup()
  }

  # bar plot; uses facet_grid for rows=facetvar, cols=stage
  mk_bar <- function(df, xvar, facetvar, title, reef = FALSE) {
    p <- ggplot(df, aes({{ xvar }}, prop)) +
      geom_col(color = "black") +
      facet_grid(rows = vars({{ facetvar }}), cols = vars(stage)) +
      labs(title = title)+
      scale_y_continuous(limits = c(0, 1), expand = expansion(mult = c(0, 0.05)))
    if (reef) {
      p <- p +
        scale_x_discrete(limits = REEF_LEVELS, drop = FALSE) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))
    }
    p
  }

  # data
  exp2_loc    <- mk_props(df_group_long, location_code, tank)
  exp2_round  <- mk_props(df_group_long, location_code, round)
  exp2_loc2   <- mk_props(df_group_long, reef_type,     tank)
  exp2_round2 <- mk_props(df_group_long, reef_type,     round)

  # plots
  p_exp2_loc    <- mk_bar(exp2_loc,   location_code, tank,  "Location by tank")
  p_exp2_round  <- mk_bar(exp2_round, location_code, round, "Location by round")
  p_exp2_loc2   <- mk_bar(exp2_loc2,  reef_type,     tank,  "Reeftype by tank",  reef = TRUE)
  p_exp2_round2 <- mk_bar(exp2_round2,reef_type,     round, "Reeftype by round", reef = TRUE)

  loc_round_plots_exp2 <<- p_exp2_loc + p_exp2_loc2 + p_exp2_round + p_exp2_round2 +
    patchwork::plot_layout(ncol = 4)
}))
loc_round_plots_exp2

```

## Exp 2 III
```{r}
#| label: Exp 2 III
#| fig-width: 6
#| fig-height: 7
#| dpi: 120
#| fig-cap: "."

exp2_reef_koura <- df_group_long %>%
  mutate(stage = toupper(stage)) %>%
  filter(stage %in% c("L0","L1")) %>%
  count(stage, reef_type, koura_id, name = "n") %>%
  group_by(stage, koura_id) %>%
  mutate(N = sum(n), prop = n / N) %>%
  ungroup() %>%
  relevel_reef()

p_exp2_reef_koura <- exp2_reef_koura %>%
  relevel_reef() %>%
  ggplot(aes(reef_type, prop)) +
  geom_col(color = "black") +
  facet_wrap(koura_id ~ stage, nrow = 6) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p_exp2_reef_koura


exp2_use <- df_group_long %>% 
  filter(stage %in% c("L0","L1"))

counts <- exp2_use %>%
  filter(!is.na(reef_type), !is.na(size_class)) %>%
  mutate(
    tank = factor(tank),
    round = factor(round),
    stage = factor(stage, levels = c("L0","L1")),
    reef_type  = fct_relevel(reef_type,"SingleStone","FlatStone","StonePile","WoodLog","TankWall"),
    size_class = factor(size_class)) %>%
  count(stage, round, tank, reef_type, size_class, name = "number_koura") %>%
  complete(stage, round, tank, reef_type, size_class, fill = list(number_koura = 0))

p_stack <- ggplot(counts, aes(reef_type, number_koura, fill = size_class)) +
  geom_col() +
  facet_grid(round ~ tank+stage  , scales = "free_x")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p_stack
```

## Exp 2 Statistic
```{r}
#| label: Statistics Exp 2
#| fig-width: 6
#| fig-height: 7
#| dpi: 120
#| fig-cap: "."

df2 <- df_group_long %>%
  mutate(
    reef_type      = factor(reef_type),
    stage          = factor(stage, levels = c("L0", "L1")),
    sex            = factor(sex),
    size_class     = factor(size_class, levels = c("S", "M", "L")),
    location_code  = factor(location_code),
    tank           = factor(tank),
    round          = factor(round),
    group_id       = factor(group_id),
    koura_id       = factor(koura_id)) %>%
  filter(!is.na(reef_type))

form_exp2 <- reef_type ~ stage + size_class + (1 | group_id) + (1 | tank) + (1 | round)

#m_exp2 <- brm(formula = form_exp2, data = df2, family = categorical(link = "logit"), chains= 4, cores = 4,  iter = 4000, seed = 1)

#summary(m_exp2)
```

# Exp 3 Wood/stone
```{r}
#| label: Exp 3
#| fig-width: 6
#| fig-height: 7
#| dpi: 120
#| fig-cap: "."

exp3_reef <- df_stonewood_long %>%
  filter(stage %in% c("L0","L1"), !is.na(reef_type)) %>%
  count(stage, reef_type, name = "n") %>%
  group_by(stage) %>%
  mutate(N = sum(n), prop = n / N) %>%
  ungroup() %>% relevel_reef3()

exp3_reef_size <- df_stonewood_long %>%
  filter(stage %in% c("L0","L1"), !is.na(reef_type)) %>%
  count(stage, reef_type, size_class, name = "n") %>%
  group_by(stage, size_class) %>%
  mutate(N = sum(n), prop = n / N) %>%
  ungroup() %>% relevel_reef3()


# Panel labels and order
lab_stage   <- c(L0 = "Initial location (L0)", L1 = "Next-day location (L1)")
PANEL_LEVELS <- c("Combined","S","M","L")
lab_panel    <- c(Combined = "Combined", S = "Small", M = "Medium", L = "Large")

# Build combined counts
exp3_top <- exp3_reef %>%
  mutate(panel = factor("Combined", levels = PANEL_LEVELS))

exp3_bot <- exp3_reef_size %>%
  mutate(panel = factor(as.character(size_class), levels = PANEL_LEVELS))

exp3_all <- bind_rows(exp3_top, exp3_bot)

# One plot with a left strip for every row (Combined, S, M, L)
p_exp3_reef_all <- exp3_all %>%
  #dplyr::left_join(exp3_all_L, by = c("stage","reef_type","panel")) %>% relevel_reef3() %>% 
  ggplot(aes(reef_type, prop)) +
  geom_col(color = "black") +
  #geom_text(aes(y = prop + 0.1, label = .label)) +
  facet_grid(panel ~ stage, labeller = labeller(stage = lab_stage, panel = lab_panel)) +
  labs(x = "Reef type", y = "Proportion")

p_exp3_reef_all
ggsave(p_exp3_reef_all, file = file.path(fig_dir, "Exp3_reef_p.png"), width = 8, height = 8, dpi = 300)

```

## Exp 3 II
```{r}
#| label: Exp 3 II
#| fig-width: 6
#| fig-height: 7
#| dpi: 120
#| fig-cap: "."

invisible(capture.output({
  # proportions by x var and facet var (per stage)
  mk_props <- function(data, xvar, facetvar) {
    data %>%
      dplyr::filter(stage %in% c("L0","L1")) %>%
      dplyr::count(stage, {{ xvar }}, {{ facetvar }}, name = "n") %>%
      dplyr::group_by(stage, {{ facetvar }}) %>%
      dplyr::mutate(N = sum(n), prop = n / N) %>%
      dplyr::ungroup()
  }

# bar plot; uses facet_grid for rows=facetvar, cols=stage
  mk_bar <- function(df, xvar, facetvar, title, reef = FALSE) {
    p <- ggplot(df, aes({{ xvar }}, prop)) +
      geom_col(color = "black") +
      facet_grid(rows = vars({{ facetvar }}), cols = vars(stage)) +
      labs(title = title)+
      scale_y_continuous(limits = c(0, 1), expand = expansion(mult = c(0, 0.05)))
    if (reef) {
      p <- p +
        scale_x_discrete(limits = REEF_LEVELS3, drop = FALSE) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))
    }
    p
  }
  # data
  exp3_loc    <- mk_props(df_stonewood_long, location_code, tank)
  exp3_round  <- mk_props(df_stonewood_long, location_code, round)
  exp3_loc3   <- mk_props(df_stonewood_long, reef_type,     tank)
  exp3_round3 <- mk_props(df_stonewood_long, reef_type,     round)
  # plots
  p_exp3_loc    <- mk_bar(exp3_loc,   location_code, tank,  "Location by tank")
  p_exp3_round  <- mk_bar(exp3_round, location_code, round, "Location by round")
  p_exp3_loc3   <- mk_bar(exp3_loc3,  reef_type,     tank,  "Reeftype by tank",  reef = TRUE)
  p_exp3_round3 <- mk_bar(exp3_round3,reef_type,     round, "Reeftype by round", reef = TRUE)

loc_round_plots_exp3 <<- p_exp3_loc + p_exp3_loc3 + p_exp3_round + p_exp3_round3 +
    patchwork::plot_layout(ncol = 4)
}))

loc_round_plots_exp3
```

## Exp 3 Statistic
```{r}
#| label: Statistics Exp 3
#| fig-width: 6
#| fig-height: 7
#| dpi: 120
#| fig-cap: "."

df3 <- df_stonewood_long %>%
  mutate(
    reef_type      = factor(reef_type),
    stage          = factor(stage, levels = c("L0", "L1")),
    sex            = factor(sex),
    size_class     = factor(size_class, levels = c("S", "M", "L")),
    location_code  = factor(location_code),
    tank           = factor(tank),
    round          = factor(round),
    group_id       = factor(group_id),
    koura_id       = factor(koura_id)
  ) %>%
  filter(!is.na(reef_type))

## Set FlatStone as reference so coefficients are for WoodSplit vs FlatStone
df3 <- df3 %>% mutate(reef_type = relevel(reef_type, ref = "FlatStone"))

m_exp3 <- glmer(
  reef_type ~ stage + size_class + (1 | group_id) + (1 | koura_id) + (1 | tank) + (1 | round),
  data    = df3,
  family  = binomial(link = "logit"),
  control = glmerControl(optimizer = "bobyqa")
)

summary(m_exp3)
```

# Exp 4 Bricks
```{r}
#| label: Exp 4 
#| fig-width: 6
#| fig-height: 7
#| dpi: 120
#| fig-cap: "."

exp4_reef <- df_brick_long %>%
  dplyr::filter(stage %in% c("L1"), !is.na(reef_type)) %>%
  dplyr::count(stage, reef_type, name = "n") %>%
  dplyr::group_by(stage) %>%
  dplyr::mutate(N = sum(n), prop = n / N) %>%
  dplyr::ungroup() %>%
  relevel_reef4()

# By SEX
exp4_reef_sex <- df_brick_long %>%
  dplyr::filter(stage %in% c("L1")) %>%
  dplyr::count(stage, reef_type, sex, name = "n") %>%
  dplyr::group_by(stage, sex) %>%
  dplyr::mutate(N = sum(n), prop = n / N) %>%
  dplyr::ungroup() %>%
  relevel_reef4() %>%
  dplyr::mutate(panel = dplyr::recode(sex, F = "Female", M = "Male"))

# By SIZE
exp4_reef_size <- df_brick_long %>%
  dplyr::filter(stage %in% c("L1")) %>%
  dplyr::count(stage, reef_type, size_class, name = "n") %>%
  dplyr::group_by(stage, size_class) %>%
  dplyr::mutate(N = sum(n), prop = n / N) %>%
  dplyr::ungroup() %>%
  relevel_reef4()

# Labels (facets)
lab_stage     <- c(L1 = "Next-day location (L1)")
PANEL_LEVELS  <- c("Combined","M","F")
lab_panel     <- c(Combined = "Combined", M = "Male", F = "Female")

PANEL_LEVELS2 <- c("Combined","S","M","L")
lab_panel2    <- c(Combined = "Combined", S = "Small", M = "Medium", L = "Large")

# ---- SEX ----
sex_n <- exp4_reef_sex %>%
  group_by(sex) %>%
  summarise(n_total = sum(n), .groups = "drop")

# Build named vector for labeller
lab_panel_n_sex <- setNames(paste0(c("Combined", sex_n$sex),c(" (combined)",paste0(" (n=", sex_n$n_total, ")"))),c("Combined", sex_n$sex))

# Rename F/M to Female/Male with n
lab_panel_n_sex <- c( Combined = "Combined",  M = paste0("Male"), F = paste0("Female"))  

# ---- SIZE ----
size_n <- exp4_reef_size %>%
  group_by(size_class) %>%
  summarise(n_total = sum(n), .groups = "drop")

lab_panel_n_size <- c(  Combined = "Combined",S = paste0("Small"),M = paste0("Medium"),L = paste0("Large"))

# ---------- SEX analysis ----------
# Build combined counts
exp4_sex_top <- exp4_reef %>%
  dplyr::mutate(panel = factor("Combined", levels = PANEL_LEVELS))

exp4_sex_bot <- exp4_reef_sex %>%
  dplyr::mutate(panel = factor(as.character(sex), levels = PANEL_LEVELS))

exp4_sex_all <- dplyr::bind_rows(exp4_sex_top, exp4_sex_bot)

# Plot
p_exp4_sex <- exp4_sex_all %>%
  relevel_reef4() %>%
  ggplot(aes(reef_type, prop)) +
  geom_col(color = "black") +
  facet_grid(panel ~ stage,
             labeller = labeller(
               stage = lab_stage,
               panel = lab_panel_n_sex )) +
  labs(x = "Reef type", y = "Proportion")

p_exp4_sex

ggplot2::ggsave(filename = file.path(fig_dir, "Exp4_sex_p.png"),plot = p_exp4_sex,width = 8, height = 8, dpi = 300)

# ---------- SIZE analysis (standalone) ----------

# Build combined counts
exp4_size_top <- exp4_reef %>%
  dplyr::mutate(panel = factor("Combined", levels = PANEL_LEVELS2))

exp4_size_bot <- exp4_reef_size %>%
  dplyr::mutate(panel = factor(as.character(size_class), levels = PANEL_LEVELS2))

exp4_size_all <- dplyr::bind_rows(exp4_size_top, exp4_size_bot)

# Plot
p_exp4_size <- exp4_size_all %>%
  relevel_reef4() %>%
  ggplot(aes(reef_type, prop)) +
  geom_col(color = "black") +
  facet_grid(panel ~ stage,
             labeller = labeller(
               stage = lab_stage,
               panel = lab_panel_n_size)) +
  labs(x = "Reef type", y = "Proportion")

p_exp4_size

ggplot2::ggsave(filename = file.path(fig_dir, "Exp4_size_p.png"), plot = p_exp4_size, width = 8, height = 8, dpi = 300)

p_exp4combined <- p_exp4_sex + p_exp4_size 
p_exp4combined

ggplot2::ggsave(filename = file.path(fig_dir, "Exp4_size_sex_p.png"), plot = p_exp4combined, width = 8, height = 8, dpi = 300)
```

## Exp 4 II
```{r}
#| label: Exp 4
#| fig-width: 6
#| fig-height: 7
#| dpi: 120
#| fig-cap: "."

df_brick_long %>%
  group_by(group_id, size_class, sex, reef_type) %>%
  summarise(n = n(), .groups = "drop") %>%
  arrange(group_id, size_class)

df_brick_long %>%
  ggplot(aes(x = factor(group_id), fill = size_class)) +
  geom_bar(position = "fill") +  # use "stack" to show raw counts
  labs(x = "Group ID", y = "Proportion", fill = "Size class") +
  theme_bw()

df_brick_long %>%
  ggplot(aes(x = factor(group_id), fill = interaction(sex, size_class))) +
  geom_bar(position = "fill") +
  labs(x = "Group ID", y = "Proportion", fill = "Sex × Size class") +
  theme_bw()

invisible(capture.output({
  # proportions by x var and facet var (per stage)
  mk_props <- function(data, xvar, facetvar) {
    data %>%
      dplyr::filter(stage %in% c("L0","L1")) %>%
      dplyr::count(stage, {{ xvar }}, {{ facetvar }}, name = "n") %>%
      dplyr::group_by(stage, {{ facetvar }}) %>%
      dplyr::mutate(N = sum(n), prop = n / N) %>%
      dplyr::ungroup()
  }
  # bar plot; uses facet_grid for rows=facetvar, cols=stage
  mk_bar <- function(df, xvar, facetvar, title, reef = FALSE) {
    p <- ggplot(df, aes({{ xvar }}, prop)) +
      geom_col(color = "black") +
      facet_grid(rows = vars({{ facetvar }}), cols = vars(stage)) +
      labs(title = title)+
      scale_y_continuous(limits = c(0, 1), expand = expansion(mult = c(0, 0.05)))
    if (reef) {
      p <- p +
        scale_x_discrete(limits = REEF_LEVELS4, drop = FALSE) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))
    }
    p
  }

  # data
  exp4_loc    <- mk_props(df_brick_long, location_code, tank)
  exp4_round  <- mk_props(df_brick_long, location_code, round)
  exp4_loc4   <- mk_props(df_brick_long, reef_type,     tank)
  exp4_round4 <- mk_props(df_brick_long, reef_type,     round)

  # plots
  p_exp4_loc    <- mk_bar(exp4_loc,   location_code, tank,  "Location by tank")
  p_exp4_round  <- mk_bar(exp4_round, location_code, round, "Location by round")
  p_exp4_loc4   <- mk_bar(exp4_loc4,  reef_type,     tank,  "Reeftype by tank",  reef = TRUE)
  p_exp4_round4 <- mk_bar(exp4_round4,reef_type,     round, "Reeftype by round", reef = TRUE)

  loc_round_plots_exp4 <<- p_exp4_loc + p_exp4_loc4 + p_exp4_round + p_exp4_round4 +
    patchwork::plot_layout(ncol = 4)
}))

loc_round_plots_exp4

```

## Exp 4 Statistic
```{r}
#| label: Statistics Exp 4
#| fig-width: 6
#| fig-height: 7
#| dpi: 120
#| fig-cap: "."

df4 <- df_brick_long %>%
  mutate(
    reef_type      = factor(reef_type),
    stage          = factor(stage, levels = c("L0", "L1")),
    sex            = factor(sex),
    size_class     = factor(size_class, levels = c("S", "M", "L")),
    location_code  = factor(location_code),
    tank           = factor(tank),
    round          = factor(round),
    group_id       = factor(group_id),
    koura_id       = factor(koura_id)) %>%
  filter(!is.na(reef_type))

## Set Brick_Artificial as reference so coefficients are for Brick_Wood vs Brick_Artificial
df4 <- df4 %>% mutate(reef_type = relevel(reef_type, ref = "Brick_Artificial"))

m_exp4 <- glmer(
  reef_type ~ location_code + sex + size_class + (1 | group_id) + (1 | koura_id) + (1 | tank) + (1 | round),
  data    = df4,
  family  = binomial(link = "logit"),
  control = glmerControl(optimizer = "bobyqa"))

summary(m_exp4)

```

# WQ
```{r}
#| label: WQ
#| fig-width: 6
#| fig-height: 7
#| dpi: 120
#| fig-cap: "."

wq_clean <- df_wq %>%
  mutate(value = suppressWarnings(as.numeric(value)),tank  = factor(tank),param_label = ifelse(is.na(unit) | unit %in% c("", "NA"), parameter_abb, paste(parameter_abb, unit))) %>%
  filter(!is.na(tank_use), !is.na(value),data_time >= as.POSIXct("2025-09-01"),tank_use == "Experiment")

wq_probe <- wq_clean %>%
  transmute(datetime = data_time,tank,param_label,value)

# --- Logger data (df_loggers) -> give unique param_label names ---
wq_logger <- df_loggers %>%
  rename(datetime = data_time) %>%
  mutate(tank     = factor(tank),
    datetime = lubridate::ymd_hms(datetime, tz = "Pacific/Auckland")) %>%
  pivot_longer(c(temperature, light), names_to = "param", values_to = "value") %>%
  mutate(
    param_label = case_when(
      param == "temperature" ~ "Temp (°C) - Logger",
      param == "light"       ~ "Light (lux) - Logger",
      TRUE                   ~ param),
    date  = as.Date(datetime),
    time  = format(datetime, "%H:%M:%S"),
    year  = year(datetime),
    month = month(datetime, label = TRUE),
    day   = day(datetime)) %>%
  filter(
    datetime >= as.POSIXct("2025-09-01", tz = "Pacific/Auckland"),
    (param_label != "Light (lux) - Logger" | value <= 1000),
    (param_label != "Temp (°C) - Logger"   | value <= 20) ) %>%
  transmute(datetime, date, time, year, month, day, tank, param_label, value)

# --- Combine into ONE df, keep labels distinct ---
PARAM_LEVELS <- c("Temp (°C)", "Temp (°C) - Logger","Light (lux) - Logger",
                  "Press (mbars)","DO (%)","DO (mg/L)","SPC (µS/cm)","Cond (µS/cm)","SAL (ppt)","pH")

wq_all <- bind_rows(wq_probe, wq_logger) %>%
  mutate(param_label = factor(param_label, levels = PARAM_LEVELS),tank = factor(tank)) %>%
  tidyr::drop_na(value)

# --- Plot from the single df ---
wq_all_plot <- ggplot(wq_all, aes(datetime, value, color = tank, group = tank)) +
  geom_line() +
  facet_wrap(~ param_label, scales = "free_y", ncol = 2)

wq_all_plot
ggsave(wq_all_plot, file = file.path(fig_dir, "wq_all_probe_logger.png"), width = 10, height = 8, dpi = 300)

```
