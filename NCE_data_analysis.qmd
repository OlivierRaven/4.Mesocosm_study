---
title: "NCE_data"
author: "Olivier V. Raven"
format: html
editor: source
---

## Explanation of this script

(brief notes here if you want; left empty to keep as-is)

# Load packages
```{r load packages}
cat("\014"); rm(list = ls())

# Define the list of packages
packages <- c("DHARMa", "brms", "emmeans", "lme4","lmerTest","vegan","ggnewscale","multcompView","patchwork","janitor","lubridate","stringr","tidyverse","dplyr","ggplot2","readxl","writexl","readr")

# Load packages if not already installed
quiet_load <- function(pkg) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    suppressWarnings(suppressMessages(install.packages(pkg, dependencies = TRUE)))}
  suppressPackageStartupMessages(require(pkg, character.only = TRUE, quietly = TRUE))
  invisible(TRUE)}

invisible(lapply(packages, quiet_load))
```

# Load raw data
```{r Load raw data}
getwd()
exc_file_dir <- "data/raw/Mesocosm_experiment.xlsx"
raw_data_dir <- "data/raw"
der_data_dir <- "data/derived"
fig_dir      <- "figures"

# Read sheets
df_NCE_raw <- readxl::read_excel(exc_file_dir, sheet = "NCE_exp")
df_Feeding_raw <- readxl::read_excel(exc_file_dir, sheet = "Feeding")
```

# make into long format
```{r, fig.width=10, fig.height=6, dpi=100}
# filter round 9 long last of round 8.
df_NCE_raw <- df_NCE_raw %>%
  dplyr::filter(round != 9) %>%
  dplyr::select(-location_T180, -behaviour_T180)

# summaries of the test animals
grps <- list(c("treatment","light"), "treatment", "light", character(0))
tags <- c("treatment+light","treatment","light","overall")

summary_animals <- Map(function(g, tag)
  df_NCE_raw %>%
    group_by(across(all_of(g))) %>%
    summarise(n_trials = n(), mean_size = mean(size_mm1, na.rm=TRUE), sd_size = sd(size_mm1, na.rm=TRUE), min_size  = min(size_mm1, na.rm = TRUE), max_size = max(size_mm1, na.rm = TRUE), mean_weight = mean(weight_g1, na.rm=TRUE), sd_weight = sd(weight_g1,       na.rm=TRUE),min_weight = min(weight_g1, na.rm = TRUE),
      max_weight = max(weight_g1, na.rm = TRUE),.groups="drop") %>%
    mutate(grouping=tag) %>%
    { if(!"treatment"%in%g) mutate(., treatment="All") else . } %>%
    { if(!"light"%in%g)     mutate(., light="All")     else . },
  grps, tags) %>%
  bind_rows() %>%
  select(grouping, treatment, light, everything()) %>%
  arrange(factor(grouping, levels=tags), treatment, light)

summary_animals


# make into long format
koura_long <- df_NCE_raw %>%
  pivot_longer(
    cols = matches("^(location|behaviour)_"),
    names_to   = c(".value","time"),
    names_pattern = "(location|behaviour)_T?(\\d+)" ) %>%
  mutate(time = as.numeric(time))

koura_long <- koura_long %>%
  mutate(period = case_when(
    time < 60 ~ "before",
    time >= 60 & time < 240 ~ "during",
    time >= 240 ~ "after",
    TRUE ~ NA_character_))

#Group all refuge used to one refuge except next to refuge as that's still in the open
koura_long_ref <- koura_long %>%
  mutate(
    location = case_when(
      location %in% c("floor", "wall", "barrier") ~ "open",
      location %in% c("ref_back", "ref_open", "ref_next") ~ "refuge",
      TRUE ~ NA_character_),
    location = factor(location, levels = c("barrier", "open", "refuge")))

koura_long_ref <- koura_long_ref %>%
  mutate(period = case_when(
    time < 60 ~ "before",
    time >= 60 & time < 240 ~ "during",
    time >= 240 ~ "after",
    TRUE ~ NA_character_))%>%
  mutate(period = factor(period, levels = c("before", "during", "after")))

```
# beh & loc per treatment
```{r, fig.width=10, fig.height=6, dpi=100}
#loc_order <- c("ref_back","ref_open","ref_next","wall","floor","barrier")
loc_order_ref <- c("refuge","open")
beh_order <- c("static","walk","swim","climb")

# calculate the proportions of location for each treatment for each time step
prop_location_time <- koura_long_ref %>%
  filter(!is.na(location), location != "") %>%
  count(treatment, time, light, location = location, name = "n") %>%
  group_by(treatment, time, light) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(
    treatment = factor(treatment, levels = c("catfish","eel","control")),
    location  = factor(location,  levels = loc_order_ref))

# Behaviour
prop_behaviour_time <- koura_long_ref %>%
  filter(!is.na(behaviour), behaviour != "") %>%
  count(treatment, time, light, behaviour = behaviour, name = "n") %>%
  group_by(treatment, time, light) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(
    treatment = factor(treatment, levels = c("catfish","eel","control")),
    behaviour = factor(behaviour, levels = beh_order))

# plot 
p_loc_time2 <- prop_location_time%>%
  dplyr::filter(location == "refuge")%>%
  ggplot(aes(time, prop, colour = treatment, group = treatment)) +
  geom_line(linewidth = 1.5) +
  geom_vline(xintercept = c(60, 240), linetype = "dashed") +
  facet_grid(light ~ location, scales = "free_x") +
  labs(x = NULL, y = "proportion", colour = "treatment")+
  scale_y_continuous(limits = c(0, 1))

REF_plot <- p_loc_time2
REF_plot

ggsave(file.path(fig_dir, "REF_plot.png"), REF_plot, width = 10, height = 6, dpi = 300)

```

# Statistics GLMM addapted from Finbarr
```{r}
koura_stat <- koura_long_ref %>%
  select(treatment, exp_id, round, tank, time, period, light, location) 


# set factor ordering
koura_stat$location <- factor(koura_stat$location, levels = c("refuge","open"))
koura_stat$period <- factor(koura_stat$period, levels = c("before", "during", "after"))
koura_stat$tank <- factor(koura_stat$tank)
koura_stat$time_sc <- scale(koura_stat$time, center = TRUE, scale = TRUE)


# test theglmm model
m_refuge <- glmer(location ~ treatment * light * period + time_sc + (1 | tank),
  data        = koura_stat, 
  family      = binomial,
  control     = glmerControl(
    optimizer = "bobyqa",
    optCtrl   = list(maxfun = 2e5)))


sum_ref<-summary(m_refuge)
sum_ref
sim <- simulateResiduals(m_refuge)
plot(sim)
testDispersion(sim)
testZeroInflation(sim)

fixed_df <- as.data.frame(sum_ref$coefficients)
names(fixed_df) <- c("estimate", "std_error", "z_value", "p_value")
fixed_df$term <- rownames(fixed_df)
rownames(fixed_df) <- NULL
fixed_df <- fixed_df[, c("term", "estimate", "std_error", "z_value", "p_value")]
fixed_df <- fixed_df %>%
  mutate_if(is.numeric, round, digits = 3)

out_file <- file.path(fig_dir, "table_glmm_fixed_effects.csv")
write.csv(fixed_df, out_file, row.names = FALSE)

# make plot
library(ggeffects)
pred <- ggeffect(m_refuge, terms = c("period", "treatment", "light"), bias_correction = T)

# plot
m_plot<-ggplot(pred, aes(x = x, y = predicted, col = group, group = group)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2.5) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.15, colour = NA) +
  facet_wrap(~ facet, labeller = label_both) +
  scale_x_discrete("Time") +
  scale_y_continuous("Probability of hiding in refugia", limits = c(0, 1)) 

m_plot
ggsave(file.path(fig_dir, "m_plott.png"), m_plot, width = 10, height = 10, dpi = 300)


```


# koura per time
```{r, fig.width=12, fig.height=50, dpi=100}
# --- Data prep ---
koura_location_time <- koura_long %>%
  mutate(location = factor(location, levels = loc_order))

koura_behaviour_time <- koura_long %>%
  mutate(behaviour = factor(behaviour, levels = beh_order))

# --- Plots ---
p_loc_time <- ggplot(koura_long_ref, aes(time, location, col = treatment)) +
  geom_point() +  
  geom_line(aes(group = treatment))+
  geom_vline(xintercept = c(60, 240), linetype = "dashed") +
  facet_grid(exp_id~.) +
  labs(x = "time (min)", y = "location") +
  theme(legend.position = "none")

p_beh_time <- ggplot(koura_long_ref, aes(time, behaviour, col = treatment)) +
  geom_point() +
  geom_line(aes(group = treatment))+
  geom_vline(xintercept = c(60, 240), linetype = "dashed") +
  facet_grid(exp_id~.) +
  labs(x = "time (min)", y = "behaviour") 

# --- Combine ---
p_loc_time + p_beh_time

```




# Feeding experiment
```{r}
df_Feeding_raw

df_feeding <- df_Feeding_raw %>%
  filter(round != 1) %>%
  mutate(pellets_eaten_24h = total_fed - left_after_24h,
    pellets_per_g = pellets_eaten_24h / weight_g1,
    koura_id = as.factor(koura_id),
    treatment = as.factor(treatment),
    day_starve = as.factor(day_starve))

df_feeding <- df_feeding %>%
  mutate(pellets_log = log(pellets_per_g + 1))

mean(df_feeding$pellets_per_g)

summary(df_feeding)

# anova 2way
anova_2way <- aov(pellets_per_g ~ treatment * day_starve, data = df_feeding)
summary(anova_2way)

# Linear model
lm_raw <- lm(pellets_per_g ~ treatment * day_starve, data = df_feeding)
lm_log <- lm(pellets_log ~ treatment * day_starve, data = df_feeding)

summary(lm_raw)
anova(lm_raw)
summary(lm_log)
anova(lm_log)

plot(lm_raw)
shapiro.test(residuals(lm_raw))

plot(lm_log)
shapiro.test(residuals(lm_log))

ggplot(df_feeding, aes(day_starve, pellets_per_g, colour=treatment)) +
  stat_summary(fun="mean", geom="point") +
  stat_summary(fun="mean", geom="line", aes(group=treatment))



```

